# Estado Management System - Architecture Diagrams

## 1. Overall System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND LAYER                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Flutter Mobile App                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  Screens / Widgets                                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ EntregaListScreen                               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ ProformaDetailScreen                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ EstadoBadgeWidget (reusable)                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ EstadoFilterWidget (reusable)                   â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚              â–³                    â–³                       â”‚  â”‚
â”‚  â”‚              â”‚ ref.watch()        â”‚ ref.watch()          â”‚  â”‚
â”‚  â”‚              â”‚                    â”‚                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚       STATE MANAGEMENT LAYER (Riverpod)           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ FutureProviders  â”‚      â”‚ StreamProviders  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                  â”‚      â”‚                  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ estadosPor     â”‚      â”‚ â€¢ eventStream    â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   CategoriaProvider      â”‚ â€¢ connection     â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ estadoPor      â”‚      â”‚   StateStream    â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   CodigoProvider â”‚      â”‚ â€¢ categoryChangedâ”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ estadoLabel    â”‚      â”‚   Provider       â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   Provider       â”‚      â”‚ â€¢ isConnected    â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â€¢ estadoColor    â”‚      â”‚   Provider       â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   Provider       â”‚      â”‚                  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                â”‚                        â”‚             â”‚  â”‚
â”‚  â”‚                â–¼                        â–¼             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   CACHE LAYER    â”‚      â”‚ REALTIME SERVICE     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ (7-day TTL)      â”‚      â”‚                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                  â”‚      â”‚ EstadosRealtime      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ SharedPreferencesâ”‚      â”‚ Service              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                  â”‚      â”‚                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚ â€¢ connect()          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ Estado JSON â”‚  â”‚      â”‚ â€¢ eventStream        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ Compressed  â”‚  â”‚      â”‚ â€¢ connectionState    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ Timestamp   â”‚  â”‚      â”‚ â€¢ auto-reconnect     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ TTL info    â”‚  â”‚      â”‚   (exponential)      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚ â€¢ dispose()          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚         â–³                         â–³                   â”‚  â”‚
â”‚  â”‚         â”‚ cache miss             â”‚ events from       â”‚  â”‚
â”‚  â”‚         â”‚ / invalidate           â”‚ WebSocket         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â”‚
â”‚            â”‚                         â”‚                â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜
             â”‚ HTTP REST              â”‚ WebSocket      â”‚
             â”‚                        â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚           BACKEND LAYER            â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Laravel API              â”‚   â”‚  â”‚ Node.js          â”‚  â”‚
â”‚  â”‚                            â”‚   â”‚  â”‚ Socket.IO Server â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚ â”‚ /api/estados/*       â”‚   â”‚   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ â€¢ getCategorias()    â”‚   â”‚   â”‚  â”‚ â”‚ Broadcast    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ â€¢ getEstadosBy       â”‚   â”‚   â”‚  â”‚ â”‚ Channel      â”‚ â”‚  â”‚
â”‚  â”‚ â”‚   Categoria()        â”‚   â”‚   â”‚  â”‚ â”‚              â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ â€¢ getEstadoPor       â”‚   â”‚   â”‚  â”‚ â”‚ â€¢ estado:    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚   Codigo()           â”‚   â”‚   â”‚  â”‚ â”‚   cambio     â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                      â”‚   â”‚   â”‚  â”‚ â”‚ â€¢ estado:    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ Auth: Bearer Token   â”‚   â”‚   â”‚  â”‚ â”‚   creado     â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚  â”‚ â”‚ â€¢ estado:    â”‚ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚ â”‚   borrado    â”‚ â”‚  â”‚
â”‚              â–³                     â”‚  â”‚ â”‚ â€¢ estado:    â”‚ â”‚  â”‚
â”‚              â”‚                     â”‚  â”‚ â”‚   ordenado   â”‚ â”‚  â”‚
â”‚              â”‚                     â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚   MODELS & BROADCASTING       â”‚â”‚         â–³             â”‚
â”‚  â”‚                               â”‚â”‚         â”‚ broadcast   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ â”‚ Estado (Model)           â”‚  â”‚â”‚  â”‚   Laravel   â”‚     â”‚
â”‚  â”‚ â”‚ â€¢ id, categoria, codigo  â”‚  â”‚â”‚  â”‚ Broadcastingâ”‚     â”‚
â”‚  â”‚ â”‚ â€¢ nombre, color, icono   â”‚  â”‚â”‚  â”‚   Events    â”‚     â”‚
â”‚  â”‚ â”‚ â€¢ timestamps             â”‚  â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚                       â”‚
â”‚  â”‚                               â”‚â”‚                       â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚                       â”‚
â”‚  â”‚ â”‚ EstadoEvent (Broadcast)  â”‚  â”‚â”‚                       â”‚
â”‚  â”‚ â”‚ â€¢ type, categoria, codigoâ”‚  â”‚â”‚                       â”‚
â”‚  â”‚ â”‚ â€¢ timestamp, userId      â”‚  â”‚â”‚                       â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â–³
             â”‚ Database
             â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
        â”‚ Database  â”‚
        â”‚           â”‚
        â”‚ Estados   â”‚
        â”‚ Table     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Data Flow: Real-Time Update Scenario

```
TIME    USER A                    BACKEND                  USER B (Admin)
â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€                  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T=0     Viewing list of
        deliveries with
        WebSocket connected
        (indicator: ğŸŸ¢ Green)
                                                            Opens admin panel
                                                            â”‚
T=1                                                        â”‚
                                                            Changes delivery:
                                                            PROGRAMADO â†’ EN_CAMINO
                                                            â”‚
T=2                                                        Clicks "Save"
                                                            â”‚
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
T=3                                    Laravel API
                                        Updates database
                                        â”‚
                                          â”œâ”€â†’ broadcast(EstadoUpdated)
                                          â”‚
T=4                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚ Socket.IO Server    â”‚
                               â”‚                     â”‚
                               â”‚ Emit: estado:cambio â”‚
                               â”‚ {                   â”‚
                               â”‚   categoria: ...    â”‚
                               â”‚   codigo: ...       â”‚
                               â”‚   timestamp: ...    â”‚
                               â”‚ }                   â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
T=5                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  (WebSocket)
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ EstadosRealtimeService      â”‚
        â”‚ receives evento:cambio      â”‚
        â”‚                             â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚ â”‚ _onEstadoChanged()    â”‚   â”‚
        â”‚ â”‚ Parse event           â”‚   â”‚
        â”‚ â”‚ Emit to eventStream   â”‚   â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
T=6          â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ Riverpod detectsâ”‚
             â”‚ event arrived   â”‚
             â”‚                 â”‚
             â”‚ 1. Watch sees   â”‚
             â”‚    new event    â”‚
             â”‚ 2. Invalidates  â”‚
             â”‚    cache        â”‚
             â”‚ 3. Refetch from â”‚
             â”‚    API          â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
T=7          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ API returns fresh    â”‚
             â”‚ estado data          â”‚
             â”‚                      â”‚
             â”‚ Save to cache        â”‚
             â”‚ (SharedPreferences)  â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
T=8          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ UI automatically    â”‚
             â”‚ rebuilds via        â”‚
             â”‚ ref.watch()         â”‚
             â”‚                     â”‚
             â”‚ EstadoBadgeWidget:  â”‚
             â”‚ â€¢ New label         â”‚
             â”‚ â€¢ New color         â”‚
             â”‚ â€¢ New icon          â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
T=9     Screen        â”‚
        updated!      â”‚
                      â”‚
        ğŸšš EN_CAMINO
        (New label)
        (Green color)

        Latency: ~100-500ms
        User sees change nearly instantly!
```

---

## 3. Provider Dependency Graph

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   APPLICATION ENTRY POINT           â”‚
â”‚   (riverpod.ProviderScope in main) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  estadosRealtimeServiceProvider         â”‚  (FutureProvider)
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚  Dependencies:                          â”‚
â”‚  â€¢ FlutterSecureStorage (token)        â”‚
â”‚  â€¢ flutter_dotenv (WEBSOCKET_URL)      â”‚
â”‚  â€¢ socket_io_client lib                â”‚
â”‚                                         â”‚
â”‚  Returns: EstadosRealtimeService        â”‚
â”‚  Lifecycle: Singleton (app lifetime)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                  â”‚                     â”‚
             â–¼                  â–¼                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ eventStream      â”‚ â”‚ connectionState  â”‚ â”‚ forceReconnect   â”‚
    â”‚ Provider         â”‚ â”‚ StreamProvider   â”‚ â”‚ Provider         â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚ Returns Stream   â”‚ â”‚ Returns Stream   â”‚ â”‚ Returns Future   â”‚
    â”‚ <EstadoEvent>    â”‚ â”‚ <Connection>     â”‚ â”‚ <void>           â”‚
    â”‚                  â”‚ â”‚                  â”‚ â”‚ (manual trigger) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                    â”‚
             â”‚                    â”‚
             â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
             â”‚         â”‚          â”‚
             â–¼         â–¼          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ estadosProvider          â”‚ â”‚  (depends on event stream
    â”‚ (exists from Phase 4)     â”‚ â”‚   for cache invalidation)
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
    â”‚ FutureProvider.family    â”‚ â”‚
    â”‚ <List<Estado>, String>   â”‚ â”‚
    â”‚                          â”‚ â”‚
    â”‚ Dependencies:            â”‚ â”‚
    â”‚ â€¢ cacheService           â”‚ â”‚
    â”‚ â€¢ apiService             â”‚ â”‚
    â”‚ â€¢ fallback values        â”‚ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
             â”‚                   â”‚
             â”‚ (3-tier fallback) â”‚
             â”‚                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       DATA SOURCES (checked)        â”‚
    â”‚                                     â”‚
    â”‚ 1. SharedPreferences Cache          â”‚
    â”‚    (7-day TTL)                      â”‚
    â”‚                                     â”‚
    â”‚ 2. HTTP REST API                    â”‚
    â”‚    /api/estados/{categoria}         â”‚
    â”‚                                     â”‚
    â”‚ 3. Hardcoded Fallback Values        â”‚
    â”‚    FALLBACK_ESTADOS_ENTREGA         â”‚
    â”‚    FALLBACK_ESTADOS_PROFORMA        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ (filtered/derived data)
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Helper Providers                  â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
    â”‚ â€¢ estadoLabelProvider              â”‚
    â”‚ â€¢ estadoColorProvider              â”‚
    â”‚ â€¢ estadoIconProvider               â”‚
    â”‚                                    â”‚
    â”‚ All .family(String, String)        â”‚
    â”‚ (categoria, codigo)                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   WIDGETS (consume providers)     â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
    â”‚ EstadoBadgeWidget                 â”‚
    â”‚ EstadoFilterWidget                â”‚
    â”‚ EstadosConnectionIndicator        â”‚
    â”‚ EstadoBuilder                     â”‚
    â”‚                                   â”‚
    â”‚ All use: ref.watch(provider)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Cache Invalidation Flow (on WebSocket Event)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocket receives estado:cambio    â”‚
â”‚  {categoria: "entrega", ...}          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ EstadosRealtimeService  â”‚
    â”‚ _onEstadoChanged()      â”‚
    â”‚                         â”‚
    â”‚ â€¢ Parse JSON            â”‚
    â”‚ â€¢ Create EstadoEvent    â”‚
    â”‚ â€¢ Emit to stream        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ estadosEventStreamProvider emits event  â”‚
â”‚ All listeners get notified              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                  â”‚                  â”‚
              â–¼                  â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ UI Widget        â”‚ â”‚ Cache Service    â”‚ â”‚ Category Stream  â”‚
    â”‚ (re-renders)     â”‚ â”‚ (invalidates)    â”‚ â”‚ (notifies)       â”‚
    â”‚                  â”‚ â”‚                  â”‚ â”‚                  â”‚
    â”‚ EstadoBadge      â”‚ â”‚ clearEstados()   â”‚ â”‚ Emit category    â”‚
    â”‚ watches event    â”‚ â”‚ Remove from      â”‚ â”‚ name that        â”‚
    â”‚ stream via ref   â”‚ â”‚ SharedPrefs      â”‚ â”‚ changed          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ âœ“ Cache cleared  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ estadosPorCategoria      â”‚
                    â”‚ Provider detects         â”‚
                    â”‚ cache miss               â”‚
                    â”‚                          â”‚
                    â”‚ Automatically refetch:   â”‚
                    â”‚ 1. Invalidate provider   â”‚
                    â”‚ 2. Await API call       â”‚
                    â”‚ 3. Save to cache        â”‚
                    â”‚ 4. Return fresh data    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ UI gets fresh estado    â”‚
                â”‚ automatically via       â”‚
                â”‚ ref.watch()             â”‚
                â”‚                         â”‚
                â”‚ EstadoBadgeWidget       â”‚
                â”‚ rebuilds with:          â”‚
                â”‚ â€¢ New label             â”‚
                â”‚ â€¢ New color             â”‚
                â”‚ â€¢ New icon              â”‚
                â”‚                         â”‚
                â”‚ User sees change!       â”‚
                â”‚ âœ“ Updated automatically â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Network Topology

```
                    INTERNET
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Mobile â”‚     â”‚  Web    â”‚     â”‚  Admin   â”‚
    â”‚Device Aâ”‚     â”‚Browser  â”‚     â”‚ Browser  â”‚
    â”‚(Flutter)     â”‚(React)  â”‚     â”‚(React)   â”‚
    â”‚        â”‚     â”‚         â”‚     â”‚          â”‚
    â”‚ ğŸŸ¢EN   â”‚     â”‚ ğŸŸ¢OK    â”‚     â”‚ âš™ï¸EDIT   â”‚
    â”‚ VIVO   â”‚     â”‚ VIVO    â”‚     â”‚STATES    â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚               â”‚
        â”‚ WebSocket     â”‚ WebSocket     â”‚ HTTP PUT
        â”‚ (SSL/WSS)     â”‚ (SSL/WSS)     â”‚ /api/estados/
        â”‚               â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Node.js Server     â”‚
                    â”‚  Socket.IO          â”‚
                    â”‚                     â”‚
                    â”‚  Channels:          â”‚
                    â”‚  â€¢ estado:cambio    â”‚
                    â”‚  â€¢ estado:creado    â”‚
                    â”‚  â€¢ estado:borrado   â”‚
                    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Laravel Backend     â”‚
                    â”‚                      â”‚
                    â”‚  Routes:             â”‚
                    â”‚  â€¢ GET /estados/..   â”‚
                    â”‚  â€¢ POST /estados/.   â”‚
                    â”‚  â€¢ PUT /estados/..   â”‚
                    â”‚  â€¢ DELETE /estados/. â”‚
                    â”‚                      â”‚
                    â”‚  Broadcasting:       â”‚
                    â”‚  â€¢ EstadoCreated     â”‚
                    â”‚  â€¢ EstadoUpdated     â”‚
                    â”‚  â€¢ EstadoDeleted     â”‚
                    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  PostgreSQL/MySQL    â”‚
                    â”‚  Database            â”‚
                    â”‚                      â”‚
                    â”‚  Table: estados      â”‚
                    â”‚  â€¢ id                â”‚
                    â”‚  â€¢ categoria         â”‚
                    â”‚  â€¢ codigo            â”‚
                    â”‚  â€¢ nombre            â”‚
                    â”‚  â€¢ color             â”‚
                    â”‚  â€¢ timestamps        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. State Transitions During Real-Time Sync

```
BEFORE WebSocket Event
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EstadoConnectionState:              â”‚
â”‚ â€¢ isConnected: true                 â”‚
â”‚ â€¢ isConnecting: false               â”‚
â”‚ â€¢ error: null                       â”‚
â”‚ â€¢ lastConnected: 2 mins ago         â”‚
â”‚                                     â”‚
â”‚ Cache State:                        â”‚
â”‚ â€¢ SharedPreferences:                â”‚
â”‚   estados_cache_entrega: [...states]â”‚
â”‚   timestamp: valid (< 7 days)       â”‚
â”‚                                     â”‚
â”‚ UI State:                           â”‚
â”‚ â€¢ Displaying cached estado          â”‚
â”‚ â€¢ Badge shows: "EN_CAMINO" (green)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EVENT: WebSocket receives "estado:cambio"
       {categoria: "entrega", codigo: "ENTREGADO"}

DURING: Cache Invalidation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EstadoConnectionState:              â”‚
â”‚ â€¢ isConnected: true                 â”‚
â”‚ â€¢ isConnecting: false               â”‚ (no change)
â”‚ â€¢ error: null                       â”‚
â”‚                                     â”‚
â”‚ Cache State:                        â”‚
â”‚ â€¢ Invalidated (CLEARED)             â”‚
â”‚ â€¢ Cache miss for next access        â”‚
â”‚                                     â”‚
â”‚ UI State:                           â”‚
â”‚ â€¢ Widget detects cache miss         â”‚
â”‚ â€¢ Starts loading (spinner)          â”‚
â”‚ â€¢ Calls API to refetch              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AFTER: Fresh Data Loaded
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EstadoConnectionState:              â”‚
â”‚ â€¢ isConnected: true                 â”‚
â”‚ â€¢ isConnecting: false               â”‚
â”‚ â€¢ error: null                       â”‚
â”‚ â€¢ lastConnected: now()              â”‚
â”‚                                     â”‚
â”‚ Cache State:                        â”‚
â”‚ â€¢ Repopulated with fresh data       â”‚
â”‚ â€¢ New estado: "ENTREGADO"           â”‚
â”‚ â€¢ New timestamp: now()              â”‚
â”‚ â€¢ TTL: 7 days from now              â”‚
â”‚                                     â”‚
â”‚ UI State:                           â”‚
â”‚ â€¢ Badge updated                     â”‚
â”‚ â€¢ Label: "Entregado"                â”‚
â”‚ â€¢ Color: "#22c55e" (green)          â”‚
â”‚ â€¢ Icon: "âœ“"                         â”‚
â”‚ â€¢ User sees change instantly!       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Error Recovery Scenarios

```
SCENARIO 1: Network Disconnect
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Connected   â”‚
â”‚ ğŸŸ¢ En vivo  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Network lost (WiFi off)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EstadosRealtimeService       â”‚
â”‚ onDisconnect triggered       â”‚
â”‚                              â”‚
â”‚ Set state: CONNECTING        â”‚
â”‚ ğŸŸ¡ Sincronizando...          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Schedule reconnect
       â”‚ Delay: 1s
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Attempt 1: connect()         â”‚
â”‚ âœ— Still no network           â”‚
â”‚                              â”‚
â”‚ Schedule retry               â”‚
â”‚ Delay: 2s (exponential)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Attempt 2: connect()         â”‚
â”‚ âœ— Still no network           â”‚
â”‚                              â”‚
â”‚ Schedule retry               â”‚
â”‚ Delay: 4s                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ [Network comes back]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Attempt 3: connect()         â”‚
â”‚ âœ“ Connected!                 â”‚
â”‚                              â”‚
â”‚ Set state: CONNECTED         â”‚
â”‚ ğŸŸ¢ En vivo                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Total attempt strategy:
Max attempts: 5
Delays: 1s â†’ 2s â†’ 4s â†’ 8s â†’ 16s
Max delay: 30s (with jitter)
Jitter: 0-1000ms random (prevents thundering herd)


SCENARIO 2: Auth Token Expired
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Connected   â”‚
â”‚ ğŸŸ¢ En vivo  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ API returns 401 Unauthorized
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EstadosApiService detects 401â”‚
â”‚ Token expired                â”‚
â”‚                              â”‚
â”‚ Result: throw Exception      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Caught in estadosPor
       â”‚ CategoriaProvider
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Fallback Strategy:           â”‚
â”‚ 1. Try cache âœ“              â”‚
â”‚ 2. Try API âœ— (401)          â”‚
â”‚ 3. Use hardcoded fallback âœ“ â”‚
â”‚                              â”‚
â”‚ UI still works!              â”‚
â”‚ (7-day old data or fallback) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


SCENARIO 3: Server Down
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Connected   â”‚
â”‚ ğŸŸ¢ En vivo  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Backend server maintenance
       â”‚ WebSocket times out
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EstadosRealtimeService       â”‚
â”‚ onError() triggered          â”‚
â”‚ Error: Connection timeout    â”‚
â”‚                              â”‚
â”‚ Set state: DISCONNECTED      â”‚
â”‚ ğŸ”´ Sin conexiÃ³n              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Schedule reconnect
       â”‚ (exponential backoff)
       â”‚
       â”‚ Meanwhile, users continue
       â”‚ using app with cache data
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Fallback to cache:           â”‚
â”‚ â€¢ Show cached estado data    â”‚
â”‚ â€¢ Disable real-time updates  â”‚
â”‚ â€¢ Show warning banner:       â”‚
â”‚   "Sincronizando..."         â”‚
â”‚                              â”‚
â”‚ App still functional âœ“       â”‚
â”‚ No crashes âœ“                 â”‚
â”‚ User can still work âœ“        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ [Server comes back]
       â”‚ Reconnect succeeds
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Back to normal:              â”‚
â”‚ ğŸŸ¢ En vivo                   â”‚
â”‚ Cache invalidated            â”‚
â”‚ Fresh data refetched         â”‚
â”‚ Banner removed               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary

This architecture provides:

âœ… **Real-time Updates** - WebSocket events propagate changes instantly
âœ… **Reliable Fallbacks** - 3-tier strategy (cache â†’ API â†’ hardcoded)
âœ… **Auto-Recovery** - Exponential backoff reconnection
âœ… **Offline Support** - 7-day cache TTL for offline usage
âœ… **Type Safety** - Full TypeScript/Dart type checking
âœ… **High Performance** - 99% bandwidth reduction vs polling
âœ… **User Experience** - Auto UI updates without refresh
âœ… **Production Ready** - Comprehensive error handling
